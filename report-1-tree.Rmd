---
title: "Homework 1: Tree ensemble models"
subtitle: "Data Science 2: Machine Learning Tools - CEU 2021"
author: "Abduvosid Malikov"
output: bookdown::html_document2

---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo = FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(ggplot2)
library(caret)

library(xtable)
library(gridExtra)
library(ggthemes)
library(lattice)
library(glmnet)
library(rattle)
library(Hmisc)
library(modelsummary)

library(h2o)
library(rpart)
library(rpart.plot)
```

```{r, echo = FALSE, message=FALSE, warning=FALSE}

h2o.init()

# stop 
h2o.shutdown()

```



## EDA


```{r data, echo=FALSE}

data <- as_tibble(ISLR::OJ)

```

In this problem we are going to work with the Orange Juice dataset from the ISLR package. This dataset contains 1070 purchases where the customer either purchased Citrus Hill (CH) or Minute Maid (MM) Orange Juice. There are 18 variables that presents customer and product characteristics. The goal is to predict which of the juices is chosen in a given purchase situation. 

A description of the variables.

There are a number of characteristics of the customer and product that are recorded. There are 2 factor variables and 16 numeric variables. 

Purchase
A factor with levels CH and MM indicating whether the customer purchased Citrus Hill or Minute Maid Orange Juice

Store7
A factor with levels No and Yes indicating whether the sale is at Store 7



```{r, echo = FALSE, message=FALSE, warning=FALSE}

?ISLR::OJ
```


```{r, echo = FALSE, message=FALSE, warning=FALSE}

summary(data)
```

Purchase:
CH 653
MM 417

Price of CH varies from 1690 to 2090. Price of MM varies from 1690 to 2290. The higher maximum price of MM can be one of the reasons why there were less purchase of juice of this kind. 

However, maximum Discount offered for MM was higher than it is for CH juice (0.80 vs. 0.50). 


```{r, echo = FALSE, message=FALSE, warning=FALSE}


skimr::skim(data)
```


```{r, echo = FALSE, message=FALSE, warning=FALSE}

plot(data$Purchase,data$PriceCH)

```



```{r, echo = FALSE, message=FALSE, warning=FALSE}

h2o_data <- as.h2o(data)
my_seed <- 20210312
str(h2o_data)
```

```{r, echo = FALSE, message=FALSE, warning=FALSE}
splitted_data <- h2o.splitFrame(h2o_data, ratios = c(0.75), seed = my_seed)
data_train <- splitted_data[[1]]
data_test <- splitted_data[[2]]
```




```{r, echo = FALSE, message=FALSE, warning=FALSE}
y <- "Purchase"
X <- setdiff(names(h2o_data), y)

simple_tree <- h2o.randomForest(
  X, y,
  training_frame = data_train,
  model_id = "tree",
  ntrees = 1, mtries = length(X), sample_rate = 1, 
  max_depth = 10,
  nfolds = 5,
  seed = my_seed
)

# h2o.mae(h2o.performance(simple_tree)) 
# h2o.mae(h2o.performance(simple_tree, data_valid))
```



```{r, echo = FALSE, message=FALSE, warning=FALSE}
rpart.plot(simple_tree)

simple_tree
```



```{r, echo = FALSE, message=FALSE, warning=FALSE}

smp_size <- floor(0.7 * nrow(data))
set.seed(my_seed)

train_ids <- sample(seq_len(nrow(data)), size = smp_size)
demo_data <- data
demo_data$train <- 0
demo_data$train[train_ids] <- 1
# Create train and test sample variables
demo_data_train <- demo_data %>% filter(train == 1)
demo_data_test <- demo_data %>% filter(train == 0)

model1 <- formula(Purchase ~ STORE)

cart1 <- train(
  model1, data = demo_data_train, method = "rpart2",
  trControl = trainControl(method="none"),
  tuneGrid= data.frame(maxdepth=1))

rpart.plot(cart1$finalModel, tweak=1, digits=1, extra=1)
```




This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
